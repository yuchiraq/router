<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - Router</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="nav-logo">Router</a>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/stats">Stats</a>
                <a href="/backups">Backups</a>
                <a href="/notifications" class="active">Notifications</a>
                <a href="/settings">GPT</a>
            </div>
        </div>
    </nav>
    <main class="container">
        <div class="header"><h1>Telegram Notifications</h1></div>

        <div class="card">
            <div class="card-header">Bot Connection</div>
            <div class="card-body">
                <div class="form-inline" style="margin-bottom:12px;">
                    <label><input type="checkbox" id="enabled" title="Включить отправку уведомлений в Telegram"> Enable notifications</label>
                </div>
                <div class="form-inline" style="margin-bottom:12px;">
                    <input class="form-control" id="token" placeholder="Bot token (123456:ABC...)" title="Токен Telegram-бота от @BotFather">
                    <input class="form-control" id="chatIds" placeholder="Chat IDs (comma separated, e.g. -100123, -100456)" title="ID чатов через запятую, куда отправлять уведомления">
                </div>
                <div class="form-inline" style="margin-bottom:12px;">
                    <input class="form-control" id="webhookSecret" placeholder="Webhook secret (leave empty to auto-generate)" title="Секрет для валидации webhook запросов Telegram">
                </div>
            </div>
        </div>

                <div class="card">
            <div class="card-header">Quiet Hours</div>
            <div class="card-body">
                <div class="form-inline" style="margin-bottom:12px;">
                    <label><input type="checkbox" id="quietEnabled" title="Отключать отправку уведомлений в заданный период"> Do not send notifications during this period</label>
                </div>
                <div class="form-inline" style="margin-bottom:12px;">
                    <label>From hour <input class="form-control" id="quietStart" type="number" min="0" max="23" style="max-width:110px;" value="20" title="Час начала тихого периода (0-23)"></label>
                    <label>To hour <input class="form-control" id="quietEnd" type="number" min="0" max="23" style="max-width:110px;" value="8" title="Час окончания тихого периода (0-23)"></label>
                </div>
                <p style="color:var(--text-secondary); margin:0;">Example: from 20 to 8 means quiet from 20:00 to 07:59.</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">What to Notify About</div>
            <div class="card-body" id="events-box" style="display:grid; gap:8px;">
                <label><input type="checkbox" data-event="unknown_host" title="Уведомлять при запросах на неизвестные домены"> Unknown host requests</label>
                <label><input type="checkbox" data-event="suspicious_probe" title="Уведомлять о сканировании подозрительных путей"> Suspicious path probes</label>
                <label><input type="checkbox" data-event="blocked_ip_hit" title="Уведомлять о попытках доступа с уже заблокированных IP"> Blocked IP hit attempts</label>
                <label><input type="checkbox" data-event="manual_ban" title="Уведомлять о ручной блокировке IP"> Manual ban actions</label>
                <label><input type="checkbox" data-event="manual_unban" title="Уведомлять о ручной разблокировке IP"> Manual unban actions</label>
                <label><input type="checkbox" data-event="manual_remove" title="Уведомлять об удалении IP из списка подозрительных"> Manual suspicious IP removal</label>
                <label><input type="checkbox" data-event="backup_success" title="Уведомлять об успешном завершении бэкапа"> Backup success</label>
                <label><input type="checkbox" data-event="backup_failure" title="Уведомлять об ошибках бэкапа"> Backup failures</label>
                <label><input type="checkbox" data-event="test" title="Разрешить отправку тестовых сообщений"> Test messages</label>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Actions</div>
            <div class="card-body">
                <div class="form-inline">
                    <button class="btn" id="save-btn" type="button">Save Notification Settings</button>
                    <button class="btn" id="test-btn" type="button">Send Test Message</button>
                </div>
                <p id="status-msg" style="margin-top:12px;color:var(--text-secondary);"></p>
            </div>
        </div>

        <script>
            (function () {
                function setStatus(text, isError) {
                    var el = document.getElementById('status-msg');
                    if (!el) return;
                    el.textContent = text || '';
                    el.style.color = isError ? 'var(--accent-red)' : 'var(--text-secondary)';
                }

                function loadData() {
                    return fetch('/notifications/data', { credentials: 'same-origin' })
                        .then(function (response) {
                            if (!response.ok) throw new Error('failed to load notification settings');
                            return response.json();
                        })
                        .then(function (data) {
                            var cfg = data.config || {};
                            var events = cfg.events || {};
                            document.getElementById('enabled').checked = !!cfg.enabled;
                            document.getElementById('token').value = cfg.token || '';
                            document.getElementById('chatIds').value = (cfg.chatIds || []).join(',');
                            document.getElementById('webhookSecret').value = cfg.webhookSecret || '';
                            document.getElementById('quietEnabled').checked = !!cfg.quietHoursOn;
                            document.getElementById('quietStart').value = (cfg.quietHoursStart !== undefined ? cfg.quietHoursStart : 20);
                            document.getElementById('quietEnd').value = (cfg.quietHoursEnd !== undefined ? cfg.quietHoursEnd : 8);
                            var checks = document.querySelectorAll('[data-event]');
                            for (var i = 0; i < checks.length; i++) {
                                var key = checks[i].getAttribute('data-event');
                                checks[i].checked = !!events[key];
                            }
                        })
                        .catch(function (e) { setStatus(e.message || String(e), true); });
                }

                function saveConfig() {
                    var body = new URLSearchParams();
                    body.set('enabled', document.getElementById('enabled').checked ? 'on' : '');
                    body.set('token', document.getElementById('token').value.trim());
                    body.set('chatIds', document.getElementById('chatIds').value.trim());
                    body.set('webhookSecret', document.getElementById('webhookSecret').value.trim());
                    body.set('quietEnabled', document.getElementById('quietEnabled').checked ? 'on' : '');
                    body.set('quietStart', document.getElementById('quietStart').value || '20');
                    body.set('quietEnd', document.getElementById('quietEnd').value || '8');
                    var checks = document.querySelectorAll('[data-event]');
                    for (var i = 0; i < checks.length; i++) {
                        var key = checks[i].getAttribute('data-event');
                        body.set('event_' + key, checks[i].checked ? 'on' : '');
                    }
                    return fetch('/notifications/config', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: body.toString()
                    }).then(function (response) {
                        if (!response.ok) throw new Error('failed to save settings');
                        return response.json().then(function(payload) {
                            if (payload && payload.config) {
                                document.getElementById('webhookSecret').value = payload.config.webhookSecret || '';
                            }
                            setStatus('Notification settings saved and webhook configured.', false);
                        });
                    });
                }

                function testNotify() {
                    return fetch('/notifications/test', {
                        method: 'POST',
                        credentials: 'same-origin'
                    }).then(function (response) {
                        if (!response.ok) {
                            return response.text().then(function (t) { throw new Error(t || 'test failed'); });
                        }
                        setStatus('Test message sent.', false);
                    });
                }

                document.getElementById('save-btn').addEventListener('click', function () {
                    saveConfig().catch(function (e) { setStatus(e.message || String(e), true); });
                });
                document.getElementById('test-btn').addEventListener('click', function () {
                    testNotify().catch(function (e) { setStatus(e.message || String(e), true); });
                });

                loadData();
            })();
        </script>
    </main>
</body>
</html>
