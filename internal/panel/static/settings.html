<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройки GPT - Router</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="/account" class="nav-logo">Router</a>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/stats">Stats</a>
                <a href="/backups">Backups</a>
                <a href="/notifications">Notifications</a>
                <a href="/settings" class="active">GPT</a>
            </div>
        </div>
    </nav>
    <main class="container">
        <div class="header"><h1>Настройки GPT</h1></div>

        <div class="card">
            <div class="card-header">Общие параметры</div>
            <div class="card-body">
                <div style="margin-bottom:16px;">
                    <label for="enabled" style="display:block; margin-bottom:8px; font-weight:600;">
                        <input type="checkbox" id="enabled" title="Активирует использование GPT в Telegram-диалоге"> Включить GPT-интеграцию
                    </label>
                    <p style="color:var(--text-secondary); margin:0;">
                        Если опция включена, сервис будет использовать GPT-функции. Если выключена — GPT-настройки сохраняются,
                        но фактически не применяются до повторного включения.
                    </p>
                </div>

                <div style="margin-bottom:16px;">
                    <label for="apiKey" style="display:block; margin-bottom:8px; font-weight:600;">API ключ OpenAI</label>
                    <input class="form-control" id="apiKey" placeholder="sk-..." autocomplete="off" title="API ключ OpenAI для выполнения запросов к модели">
                    <p style="color:var(--text-secondary); margin:8px 0 0 0;">
                        Секретный ключ доступа к API. Используется для авторизации запросов к модели.
                        Рекомендуется хранить ключ приватно и периодически ротировать.
                    </p>
                </div>

                <div>
                    <label for="model" style="display:block; margin-bottom:8px; font-weight:600;">Модель</label>
                    <input class="form-control" id="model" placeholder="Например: gpt-4o-mini" title="Имя модели OpenAI, которая будет отвечать пользователям">
                    <p style="color:var(--text-secondary); margin:8px 0 0 0;">
                        Идентификатор модели, к которой будут отправляться запросы. Если поле пустое,
                        backend автоматически подставит значение по умолчанию.
                    </p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Поведение и ограничения</div>
            <div class="card-body">
                <div style="margin-bottom:16px;">
                    <label for="systemPrompt" style="display:block; margin-bottom:8px; font-weight:600;">System Prompt</label>
                    <textarea class="form-control" id="systemPrompt" placeholder="Опишите правила и стиль ответов модели" rows="7" style="min-height:140px;" title="Системная инструкция: задаёт роль, стиль и ограничения ответов"></textarea>
                    <p style="color:var(--text-secondary); margin:8px 0 0 0;">
                        Базовая инструкция для модели. Здесь можно задать тон ответов, формат,
                        ограничения по содержанию и приоритеты в обработке запросов.
                    </p>
                </div>

                <div style="margin-bottom:16px;">
                    <label for="maxLogLines" style="display:block; margin-bottom:8px; font-weight:600;">Max Log Lines</label>
                    <input class="form-control" id="maxLogLines" type="number" min="1" max="500" value="20" placeholder="1-500" title="Сколько строк контекста максимум отправлять в GPT">
                    <p style="color:var(--text-secondary); margin:8px 0 0 0;">
                        Максимальное число строк логов, которые попадут в контекст запроса к GPT.
                        Большее значение улучшает контекст, но увеличивает размер запроса и стоимость.
                    </p>
                </div>

                <div>
                    <label for="onlyChatIds" style="display:block; margin-bottom:8px; font-weight:600;">Разрешённые Chat ID</label>
                    <input class="form-control" id="onlyChatIds" placeholder="Например: -1001234567890, 12345678" title="Список Chat ID, которым разрешено общаться с GPT-ботом">
                    <p style="color:var(--text-secondary); margin:8px 0 0 0;">
                        Список чатов, которым разрешено использовать GPT-функции.
                        Указывайте ID через запятую. Если оставить поле пустым — ограничение по чатам не применяется.
                    </p>
                </div>
            </div>
        </div>


        <div class="card">
            <div class="card-header">FAQ по работе GPT-бота в Telegram</div>
            <div class="card-body" style="display:grid; gap:14px;">
                <div>
                    <strong>Как начать диалог с ботом?</strong>
                    <p style="color:var(--text-secondary); margin:6px 0 0 0;">Откройте чат с ботом в Telegram и отправьте любое сообщение. Бот ответит через GPT, если интеграция включена и настроен API ключ.</p>
                </div>
                <div>
                    <strong>Почему бот не отвечает?</strong>
                    <p style="color:var(--text-secondary); margin:6px 0 0 0;">Проверьте, что в Notifications заданы Token, Chat IDs и Webhook, а здесь включен GPT и заполнен API ключ. Также проверьте, что ваш Chat ID разрешён в поле «Разрешённые Chat ID».</p>
                </div>
                <div>
                    <strong>Как ограничить доступ к GPT?</strong>
                    <p style="color:var(--text-secondary); margin:6px 0 0 0;">Укажите список доверенных Chat ID через запятую. Если список пустой, обращаться к GPT сможет любой чат, который может писать боту.</p>
                </div>
                <div>
                    <strong>Что делает System Prompt?</strong>
                    <p style="color:var(--text-secondary); margin:6px 0 0 0;">Это глобальная инструкция модели: стиль, формат и ограничения ответов. Она применяется ко всем сообщениям пользователей.</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Действия</div>
            <div class="card-body">
                <div class="form-inline">
                    <button class="btn" id="save-btn" type="button">Сохранить настройки</button>
                </div>
                <p id="status-msg" style="margin-top:12px;color:var(--text-secondary);"></p>
            </div>
        </div>

        <script>
            (function () {
                function setStatus(text, isError) {
                    var el = document.getElementById('status-msg');
                    if (!el) return;
                    el.textContent = text || '';
                    el.style.color = isError ? 'var(--accent-red)' : 'var(--text-secondary)';
                }

                function loadData() {
                    return fetch('/settings/data', { credentials: 'same-origin' })
                        .then(function (response) {
                            if (!response.ok) throw new Error('не удалось загрузить настройки');
                            return response.json();
                        })
                        .then(function (data) {
                            var cfg = data.config || {};
                            document.getElementById('enabled').checked = !!cfg.enabled;
                            document.getElementById('apiKey').value = cfg.apiKey || '';
                            document.getElementById('model').value = cfg.model || 'gpt-4o-mini';
                            document.getElementById('systemPrompt').value = cfg.systemPrompt || '';
                            document.getElementById('maxLogLines').value = (cfg.maxLogLines !== undefined ? cfg.maxLogLines : 20);
                            document.getElementById('onlyChatIds').value = (cfg.onlyChatIds || []).join(',');
                        });
                }

                function saveData() {
                    var body = new URLSearchParams();
                    body.set('enabled', document.getElementById('enabled').checked ? 'on' : '');
                    body.set('apiKey', document.getElementById('apiKey').value || '');
                    body.set('model', document.getElementById('model').value || '');
                    body.set('systemPrompt', document.getElementById('systemPrompt').value || '');
                    body.set('maxLogLines', document.getElementById('maxLogLines').value || '20');
                    body.set('onlyChatIds', document.getElementById('onlyChatIds').value || '');

                    return fetch('/settings/config', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: body.toString()
                    }).then(function (response) {
                        if (!response.ok) throw new Error('не удалось сохранить настройки');
                        return response.json();
                    }).then(function () {
                        setStatus('Настройки успешно сохранены.', false);
                    });
                }

                document.getElementById('save-btn').addEventListener('click', function () {
                    saveData().catch(function (err) {
                        setStatus(err.message || String(err), true);
                    });
                });

                loadData().catch(function (err) {
                    setStatus(err.message || String(err), true);
                });
            })();
        </script>
    </main>
</body>
</html>
