<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stats - Router</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="/static/chart.js"></script>
    <script src="/static/color-hash.js"></script>
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="nav-logo">Router</a>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/stats" class="active">Stats</a>
            </div>
        </div>
    </nav>
    <main class="container">
        <div class="header">
            <h1>Dashboard</h1>
        </div>

        <div class="card">
            <div class="card-header">System Memory Usage</div>
            <div class="card-body">
                <canvas id="memory-chart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">System CPU Usage</div>
            <div class="card-body">
                <canvas id="cpu-chart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Requests Per Hour</div>
            <div class="card-body">
                <canvas id="requests-chart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Requests by Country</div>
            <div class="card-body">
                <div class="country-table" id="country-table"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Disk Usage</div>
            <div class="card-body">
                <div class="disk-table" id="disk-table"></div>
            </div>
        </div>

        <script>
            (function () {
                var memoryCanvas = document.getElementById('memory-chart');
                var cpuCanvas = document.getElementById('cpu-chart');
                var requestsCanvas = document.getElementById('requests-chart');
                var sshCanvas = document.getElementById('ssh-chart');

                if (!memoryCanvas || !cpuCanvas || !requestsCanvas || !sshCanvas) {
                    console.warn('Charts not initialized: missing canvas elements.');
                    return;
                }

                var memoryContext = memoryCanvas.getContext('2d');
                var cpuContext = cpuCanvas.getContext('2d');
                var requestsContext = requestsCanvas.getContext('2d');
                var sshContext = sshCanvas.getContext('2d');

                if (!memoryContext || !cpuContext || !requestsContext || !sshContext) {
                    console.warn('Charts not initialized: missing canvas contexts.');
                    return;
                }

                // --- Chart Configuration ---
                var colorHash = new ColorHash({lightness: 0.6, saturation: 0.8});
                var styles = getComputedStyle(document.documentElement);
                var chartGrid = styles.getPropertyValue('--chart-grid').trim() || 'rgba(255, 255, 255, 0.1)';
                var chartTick = styles.getPropertyValue('--chart-tick').trim() || '#a0a0a5';

                var chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { color: chartGrid },
                            ticks: { color: chartTick }
                        },
                        y: {
                            grid: { color: chartGrid },
                            ticks: { color: chartTick },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: chartTick }
                        },
                        tooltip: {
                            callbacks: {}
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    tension: 0.4
                };

                // --- Memory Chart ---
                var memoryChartOptions = {
                    responsive: chartOptions.responsive,
                    maintainAspectRatio: chartOptions.maintainAspectRatio,
                    scales: {
                        x: {
                            grid: { color: chartGrid },
                            ticks: { color: chartTick }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: chartGrid },
                            ticks: { color: '#32D74B' },
                            beginAtZero: true,
                            suggestedMax: 100,
                            title: { display: true, text: '%', color: '#32D74B' }
                        }
                    },
                    plugins: {
                        legend: chartOptions.plugins.legend,
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + ' %';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    interaction: chartOptions.interaction,
                    tension: chartOptions.tension
                };

                var memoryChart = new Chart(memoryContext, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Used (%)',
                            data: [],
                            borderColor: '#32D74B',
                            backgroundColor: 'rgba(50, 215, 75, 0.2)',
                            fill: true,
                            yAxisID: 'y'
                        }]
                    },
                    options: memoryChartOptions
                });

                // --- CPU Chart ---
                var cpuChartOptions = {
                    responsive: chartOptions.responsive,
                    maintainAspectRatio: chartOptions.maintainAspectRatio,
                    scales: {
                        x: {
                            grid: { color: chartGrid },
                            ticks: { color: chartTick }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: chartGrid },
                            ticks: { color: '#FF9F0A' },
                            beginAtZero: true,
                            suggestedMax: 100,
                            title: { display: true, text: '%', color: '#FF9F0A' }
                        }
                    },
                    plugins: {
                        legend: chartOptions.plugins.legend,
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + ' %';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    interaction: chartOptions.interaction,
                    tension: chartOptions.tension
                };

                var cpuChart = new Chart(cpuContext, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Used (%)',
                            data: [],
                            borderColor: '#FF9F0A',
                            backgroundColor: 'rgba(255, 159, 10, 0.2)',
                            fill: true,
                            yAxisID: 'y'
                        }]
                    },
                    options: cpuChartOptions
                });

                // --- Requests Chart ---
                var requestsChart = new Chart(requestsContext, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: chartOptions
                });

                
                var sshChart = new Chart(sshContext, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Established SSH sessions',
                            data: [],
                            borderColor: '#BF5AF2',
                            backgroundColor: 'rgba(191, 90, 242, 0.2)',
                            fill: true
                        }]
                    },
                    options: chartOptions
                });

                // --- Data Fetching ---
                function fetchData() {
                    fetch('/stats/data', { credentials: 'same-origin' })
                        .then(function(response) {
                            if (!response.ok) {
                                throw new Error('HTTP error! status: ' + response.status);
                            }
                            return response.json();
                        })
                        .then(function(data) {
                            if (data.memory && data.memory.labels.length > 0) {
                                memoryChart.data.labels = data.memory.labels;
                                memoryChart.data.datasets[0].data = data.memory.percents;
                                memoryChart.update();
                            }

                            if (data.cpu && data.cpu.labels.length > 0) {
                                cpuChart.data.labels = data.cpu.labels;
                                cpuChart.data.datasets[0].data = data.cpu.percents;
                                cpuChart.update();
                            }

                            if (data.requests && data.requests.datasets) {
                                requestsChart.data.labels = data.requests.labels;
                                data.requests.datasets.forEach(function(newDataset) {
                                    var existingDataset = requestsChart.data.datasets.find(function(d) {
                                        return d.label === newDataset.label;
                                    });
                                    if (existingDataset) {
                                        existingDataset.data = newDataset.data;
                                    } else {
                                        var color = colorHash.hex(newDataset.label);
                                        requestsChart.data.datasets.push({
                                            label: newDataset.label,
                                            data: newDataset.data,
                                            borderColor: color,
                                            backgroundColor: color + '33',
                                            fill: true
                                        });
                                    }
                                });
                                requestsChart.data.datasets = requestsChart.data.datasets.filter(function(d) {
                                    return data.requests.datasets.some(function(nd) {
                                        return nd.label === d.label;
                                    });
                                });

                                requestsChart.update();
                            }

                            if (data.countries) {
                                var countryTable = document.getElementById('country-table');
                                var countryRows = data.countries.map(function(country) {
                                    return (
                                        '<div class="country-row">' +
                                            '<div class="country-name">' + country.name + ' <span>(' + country.code + ')</span></div>' +
                                            '<div class="country-count">' + country.count + '</div>' +
                                        '</div>'
                                    );
                                }).join('');
                                countryTable.innerHTML = countryRows || '<div class="disk-empty">No country data yet.</div>';
                            }

                            if (data.disks) {
                                var table = document.getElementById('disk-table');
                                var rows = data.disks.map(function(disk) {
                                    return (
                                        '<div class="disk-row">' +
                                            '<div class="disk-main">' +
                                                '<div class="disk-title">' + disk.mountpoint + '</div>' +
                                                '<div class="disk-subtitle">' + disk.device + ' â€¢ ' + disk.fstype + '</div>' +
                                            '</div>' +
                                            '<div class="disk-metrics">' +
                                                '<div><strong>' + disk.usedPercent.toFixed(1) + '%</strong> used</div>' +
                                                '<div>' + disk.freeGB.toFixed(1) + ' GB free / ' + disk.totalGB.toFixed(1) + ' GB total</div>' +
                                            '</div>' +
                                            '<div class="disk-bar">' +
                                                '<div class="disk-bar-fill" style="width: ' + disk.usedPercent.toFixed(1) + '%"></div>' +
                                            '</div>' +
                                        '</div>'
                                    );
                                }).join('');
                                table.innerHTML = rows || '<div class="disk-empty">No disks found.</div>';
                            }
                        })
                        .catch(function(error) {
                            console.error('Error fetching stats data:', error);
                        });
                }

                setInterval(fetchData, 3000);
                fetchData();
            })();
        </script>
    </main>
</body>
</html>
