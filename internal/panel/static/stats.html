<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stats - Router</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="/static/chart.js"></script>
    <script src="/static/color-hash.js"></script>
    <style>
        .btn-icon { padding: 4px 8px; min-width: auto; line-height: 1; background: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); font-size: 12px; }
        .btn-icon:hover { color: var(--accent-red); border-color: var(--accent-red); background: transparent; transform: none; }
        .stats-toolbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; }
        .stats-toolbar p { margin:0; color:var(--text-secondary); }
        .stats-grid { display:grid; grid-template-columns:repeat(3, minmax(280px, 1fr)); gap:16px; grid-auto-rows:180px; }
        .stats-widget { margin-bottom:0; display:flex; flex-direction:column; min-height:0; }
        .stats-widget .card-header { display:flex; align-items:center; gap:10px; justify-content:space-between; }
        .stats-widget .card-body { flex:1; min-height:0; overflow:auto; }
        .stats-widget canvas { min-height:220px; }
        .stats-widget.dragging { opacity:0.5; border-color:var(--accent-blue); }
        .widget-handle { cursor:grab; color:var(--text-secondary); user-select:none; font-size:18px; }
        .widget-handle:active { cursor:grabbing; }
        .widget-actions { display:flex; gap:6px; margin-left:auto; }
        @media (max-width: 1100px) {
            .stats-grid { grid-template-columns:repeat(2, minmax(260px, 1fr)); }
        }
        @media (max-width: 760px) {
            .stats-grid { grid-template-columns:1fr; grid-auto-rows:minmax(220px, auto); }
            .stats-toolbar { flex-direction:column; align-items:flex-start; }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="/account" class="nav-logo">Router</a>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/stats" class="active">Stats</a>
                <a href="/backups">Backups</a>
                <a href="/notifications">Notifications</a>
                <a href="/settings">GPT</a>
            </div>
        </div>
    </nav>
    <main class="container">
        <div class="header">
            <h1>Dashboard</h1>
        </div>

        <div class="stats-toolbar">
            <p>Drag widgets by handle, resize by +/- buttons, build your own command center.</p>
            <button type="button" class="btn" id="reset-layout-btn">Reset layout</button>
        </div>

        <section class="stats-grid" id="stats-grid">
            <div class="card stats-widget" data-widget-id="memory" data-col-span="1" data-row-span="2">
                <div class="card-header">
                    <span class="widget-handle" title="Drag to move">⋮⋮</span>
                    <span>System Memory Usage</span>
                    <div class="widget-actions">
                        <button type="button" class="btn btn-icon" data-resize="wider" title="Wider">＋W</button>
                        <button type="button" class="btn btn-icon" data-resize="narrower" title="Narrower">－W</button>
                        <button type="button" class="btn btn-icon" data-resize="taller" title="Taller">＋H</button>
                        <button type="button" class="btn btn-icon" data-resize="shorter" title="Shorter">－H</button>
                    </div>
                </div>
                <div class="card-body"><canvas id="memory-chart"></canvas></div>
            </div>

            <div class="card stats-widget" data-widget-id="cpu" data-col-span="1" data-row-span="2">
                <div class="card-header">
                    <span class="widget-handle" title="Drag to move">⋮⋮</span><span>System CPU Usage</span>
                    <div class="widget-actions"><button type="button" class="btn btn-icon" data-resize="wider">＋W</button><button type="button" class="btn btn-icon" data-resize="narrower">－W</button><button type="button" class="btn btn-icon" data-resize="taller">＋H</button><button type="button" class="btn btn-icon" data-resize="shorter">－H</button></div>
                </div>
                <div class="card-body"><canvas id="cpu-chart"></canvas></div>
            </div>

            <div class="card stats-widget" data-widget-id="requests" data-col-span="2" data-row-span="2">
                <div class="card-header">
                    <span class="widget-handle" title="Drag to move">⋮⋮</span><span>Requests Per Hour</span>
                    <div class="widget-actions"><button type="button" class="btn btn-icon" data-resize="wider">＋W</button><button type="button" class="btn btn-icon" data-resize="narrower">－W</button><button type="button" class="btn btn-icon" data-resize="taller">＋H</button><button type="button" class="btn btn-icon" data-resize="shorter">－H</button></div>
                </div>
                <div class="card-body"><canvas id="requests-chart"></canvas></div>
            </div>

            <div class="card stats-widget" data-widget-id="ssh" data-col-span="2" data-row-span="2">
                <div class="card-header">
                    <span class="widget-handle" title="Drag to move">⋮⋮</span><span>SSH Connections</span>
                    <div class="widget-actions"><button type="button" class="btn btn-icon" data-resize="wider">＋W</button><button type="button" class="btn btn-icon" data-resize="narrower">－W</button><button type="button" class="btn btn-icon" data-resize="taller">＋H</button><button type="button" class="btn btn-icon" data-resize="shorter">－H</button></div>
                </div>
                <div class="card-body">
                    <div class="ssh-current" id="ssh-current">Current established: 0</div>
                    <div class="ssh-table ssh-table-head"><div>IP</div><div>Country</div><div>Date</div><div>Time</div><div>Device</div></div>
                    <div class="ssh-table" id="ssh-table"></div>
                </div>
            </div>

            <div class="card stats-widget" data-widget-id="countries" data-col-span="1" data-row-span="2">
                <div class="card-header"><span class="widget-handle" title="Drag to move">⋮⋮</span><span>Requests by Country</span><div class="widget-actions"><button type="button" class="btn btn-icon" data-resize="wider">＋W</button><button type="button" class="btn btn-icon" data-resize="narrower">－W</button><button type="button" class="btn btn-icon" data-resize="taller">＋H</button><button type="button" class="btn btn-icon" data-resize="shorter">－H</button></div></div>
                <div class="card-body"><div class="country-table" id="country-table"></div></div>
            </div>

            <div class="card stats-widget" data-widget-id="disks" data-col-span="1" data-row-span="2">
                <div class="card-header"><span class="widget-handle" title="Drag to move">⋮⋮</span><span>Disk Usage</span><div class="widget-actions"><button type="button" class="btn btn-icon" data-resize="wider">＋W</button><button type="button" class="btn btn-icon" data-resize="narrower">－W</button><button type="button" class="btn btn-icon" data-resize="taller">＋H</button><button type="button" class="btn btn-icon" data-resize="shorter">－H</button></div></div>
                <div class="card-body"><div class="disk-table" id="disk-table"></div></div>
            </div>

            <div class="card stats-widget" data-widget-id="suspicious" data-col-span="2" data-row-span="2">
                <div class="card-header"><span class="widget-handle" title="Drag to move">⋮⋮</span><span>Suspicious IPs</span><div class="widget-actions"><button type="button" class="btn btn-icon" data-resize="wider">＋W</button><button type="button" class="btn btn-icon" data-resize="narrower">－W</button><button type="button" class="btn btn-icon" data-resize="taller">＋H</button><button type="button" class="btn btn-icon" data-resize="shorter">－H</button></div></div>
                <div class="card-body">
                    <div style="display:flex; gap:8px; margin-bottom:12px; align-items:center; flex-wrap:wrap;">
                        <input type="text" id="manual-ban-ip" class="form-control" placeholder="Enter IP to ban (e.g. 203.0.113.10)" title="Введите IP-адрес для ручной блокировки" style="max-width:360px;">
                        <button class="btn btn-danger" id="manual-ban-btn" type="button">Ban IP</button>
                    </div>
                    <div class="disk-table" id="suspicious-table"></div>
                </div>
            </div>
        </section>

        <script>
            (function () {
                var memoryCanvas = document.getElementById('memory-chart');
                var cpuCanvas = document.getElementById('cpu-chart');
                var requestsCanvas = document.getElementById('requests-chart');
                if (!memoryCanvas || !cpuCanvas || !requestsCanvas) {
                    console.warn('Charts not initialized: missing canvas elements.');
                    return;
                }

                var memoryContext = memoryCanvas.getContext('2d');
                var cpuContext = cpuCanvas.getContext('2d');
                var requestsContext = requestsCanvas.getContext('2d');

                if (!memoryContext || !cpuContext || !requestsContext) {
                    console.warn('Charts not initialized: missing canvas contexts.');
                    return;
                }

                // --- Chart Configuration ---
                var colorHash = new ColorHash({lightness: 0.6, saturation: 0.8});
                var styles = getComputedStyle(document.documentElement);
                var chartGrid = styles.getPropertyValue('--chart-grid').trim() || 'rgba(255, 255, 255, 0.1)';
                var chartTick = styles.getPropertyValue('--chart-tick').trim() || '#a0a0a5';

                var chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { color: chartGrid },
                            ticks: { color: chartTick }
                        },
                        y: {
                            grid: { color: chartGrid },
                            ticks: { color: chartTick },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: chartTick }
                        },
                        tooltip: {
                            callbacks: {}
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    tension: 0.4
                };

                // --- Memory Chart ---
                var memoryChartOptions = {
                    responsive: chartOptions.responsive,
                    maintainAspectRatio: chartOptions.maintainAspectRatio,
                    scales: {
                        x: {
                            grid: { color: chartGrid },
                            ticks: { color: chartTick }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: chartGrid },
                            ticks: { color: '#32D74B' },
                            beginAtZero: true,
                            suggestedMax: 100,
                            title: { display: true, text: '%', color: '#32D74B' }
                        }
                    },
                    plugins: {
                        legend: chartOptions.plugins.legend,
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + ' %';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    interaction: chartOptions.interaction,
                    tension: chartOptions.tension
                };

                var memoryChart = new Chart(memoryContext, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Used (%)',
                            data: [],
                            borderColor: '#32D74B',
                            backgroundColor: 'rgba(50, 215, 75, 0.2)',
                            fill: true,
                            yAxisID: 'y'
                        }]
                    },
                    options: memoryChartOptions
                });

                // --- CPU Chart ---
                var cpuChartOptions = {
                    responsive: chartOptions.responsive,
                    maintainAspectRatio: chartOptions.maintainAspectRatio,
                    scales: {
                        x: {
                            grid: { color: chartGrid },
                            ticks: { color: chartTick }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: chartGrid },
                            ticks: { color: '#FF9F0A' },
                            beginAtZero: true,
                            suggestedMax: 100,
                            title: { display: true, text: '%', color: '#FF9F0A' }
                        }
                    },
                    plugins: {
                        legend: chartOptions.plugins.legend,
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + ' %';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    interaction: chartOptions.interaction,
                    tension: chartOptions.tension
                };

                var cpuChart = new Chart(cpuContext, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Used (%)',
                            data: [],
                            borderColor: '#FF9F0A',
                            backgroundColor: 'rgba(255, 159, 10, 0.2)',
                            fill: true,
                            yAxisID: 'y'
                        }]
                    },
                    options: cpuChartOptions
                });

                // --- Requests Chart ---
                var requestsChart = new Chart(requestsContext, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: chartOptions
                });

                var grid = document.getElementById('stats-grid');
                var widgets = grid ? Array.prototype.slice.call(grid.querySelectorAll('.stats-widget')) : [];
                var defaultLayout = {};
                var layoutKey = 'router_stats_layout_v1';

                function saveLayout() {
                    if (!widgets.length) return;
                    var payload = [];
                    for (var i = 0; i < widgets.length; i++) {
                        payload.push({
                            id: widgets[i].dataset.widgetId,
                            order: parseInt(widgets[i].style.order || String(i + 1), 10),
                            colSpan: parseInt(widgets[i].dataset.colSpan || '1', 10),
                            rowSpan: parseInt(widgets[i].dataset.rowSpan || '2', 10)
                        });
                    }
                    localStorage.setItem(layoutKey, JSON.stringify(payload));
                }

                function applyWidgetStyle(widget) {
                    var colSpan = Math.max(1, Math.min(3, parseInt(widget.dataset.colSpan || '1', 10)));
                    var rowSpan = Math.max(1, Math.min(4, parseInt(widget.dataset.rowSpan || '2', 10)));
                    widget.dataset.colSpan = String(colSpan);
                    widget.dataset.rowSpan = String(rowSpan);
                    widget.style.gridColumn = 'span ' + colSpan;
                    widget.style.gridRow = 'span ' + rowSpan;
                }

                function applyLayout() {
                    for (var i = 0; i < widgets.length; i++) {
                        applyWidgetStyle(widgets[i]);
                    }
                    setTimeout(function() {
                        memoryChart.resize();
                        cpuChart.resize();
                        requestsChart.resize();
                    }, 0);
                }

                function loadLayout() {
                    for (var i = 0; i < widgets.length; i++) {
                        defaultLayout[widgets[i].dataset.widgetId] = {
                            order: i + 1,
                            colSpan: parseInt(widgets[i].dataset.colSpan || '1', 10),
                            rowSpan: parseInt(widgets[i].dataset.rowSpan || '2', 10)
                        };
                    }
                    var raw = localStorage.getItem(layoutKey);
                    if (!raw) {
                        applyLayout();
                        return;
                    }
                    try {
                        var saved = JSON.parse(raw);
                        for (var s = 0; s < saved.length; s++) {
                            var item = saved[s];
                            for (var w = 0; w < widgets.length; w++) {
                                if (widgets[w].dataset.widgetId === item.id) {
                                    widgets[w].style.order = String(item.order || (w + 1));
                                    widgets[w].dataset.colSpan = String(item.colSpan || 1);
                                    widgets[w].dataset.rowSpan = String(item.rowSpan || 2);
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('Failed to restore widget layout', e);
                    }
                    applyLayout();
                }

                function resetLayout() {
                    for (var i = 0; i < widgets.length; i++) {
                        var id = widgets[i].dataset.widgetId;
                        if (!defaultLayout[id]) continue;
                        widgets[i].style.order = String(defaultLayout[id].order);
                        widgets[i].dataset.colSpan = String(defaultLayout[id].colSpan);
                        widgets[i].dataset.rowSpan = String(defaultLayout[id].rowSpan);
                    }
                    applyLayout();
                    saveLayout();
                }

                function moveWidget(dragged, target) {
                    var from = parseInt(dragged.style.order || '0', 10);
                    var to = parseInt(target.style.order || '0', 10);
                    dragged.style.order = String(to);
                    target.style.order = String(from);
                    saveLayout();
                }

                for (var wi = 0; wi < widgets.length; wi++) {
                    widgets[wi].style.order = String(wi + 1);
                    applyWidgetStyle(widgets[wi]);
                    widgets[wi].setAttribute('draggable', 'true');

                    widgets[wi].addEventListener('dragstart', function(ev) {
                        var handle = ev.target && ev.target.classList && ev.target.classList.contains('widget-handle');
                        if (!handle) {
                            ev.preventDefault();
                            return;
                        }
                        ev.currentTarget.classList.add('dragging');
                        ev.dataTransfer.setData('text/widget', ev.currentTarget.dataset.widgetId);
                    });
                    widgets[wi].addEventListener('dragend', function(ev) {
                        ev.currentTarget.classList.remove('dragging');
                    });
                    widgets[wi].addEventListener('dragover', function(ev) {
                        ev.preventDefault();
                    });
                    widgets[wi].addEventListener('drop', function(ev) {
                        ev.preventDefault();
                        var id = ev.dataTransfer.getData('text/widget');
                        if (!id || id === ev.currentTarget.dataset.widgetId) return;
                        for (var d = 0; d < widgets.length; d++) {
                            if (widgets[d].dataset.widgetId === id) {
                                moveWidget(widgets[d], ev.currentTarget);
                                return;
                            }
                        }
                    });

                    var buttons = widgets[wi].querySelectorAll('[data-resize]');
                    for (var bi = 0; bi < buttons.length; bi++) {
                        buttons[bi].addEventListener('click', function(ev) {
                            var widget = ev.currentTarget.closest('.stats-widget');
                            var type = ev.currentTarget.getAttribute('data-resize');
                            var col = parseInt(widget.dataset.colSpan || '1', 10);
                            var row = parseInt(widget.dataset.rowSpan || '2', 10);
                            if (type === 'wider') col++;
                            if (type === 'narrower') col--;
                            if (type === 'taller') row++;
                            if (type === 'shorter') row--;
                            widget.dataset.colSpan = String(col);
                            widget.dataset.rowSpan = String(row);
                            applyWidgetStyle(widget);
                            saveLayout();
                        });
                    }
                }

                var resetLayoutBtn = document.getElementById('reset-layout-btn');
                if (resetLayoutBtn) {
                    resetLayoutBtn.addEventListener('click', resetLayout);
                }

                loadLayout();

                // --- Data Fetching ---

                function banIP(ip) {
                    return fetch('/stats/ban', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: 'ip=' + encodeURIComponent(ip)
                    }).then(function(response) {
                        if (!response.ok) {
                            throw new Error('failed to ban ip ' + ip);
                        }
                    });
                }

                function unbanIP(ip) {
                    return fetch('/stats/unban', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: 'ip=' + encodeURIComponent(ip)
                    }).then(function(response) {
                        if (!response.ok) {
                            throw new Error('failed to unban ip ' + ip);
                        }
                    });
                }

                function removeIP(ip) {
                    return fetch('/stats/remove', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: 'ip=' + encodeURIComponent(ip)
                    }).then(function(response) {
                        if (!response.ok) {
                            throw new Error('failed to remove ip ' + ip);
                        }
                    });
                }

                function fetchData() {
                    fetch('/stats/data', { credentials: 'same-origin' })
                        .then(function(response) {
                            if (!response.ok) {
                                throw new Error('HTTP error! status: ' + response.status);
                            }
                            return response.json();
                        })
                        .then(function(data) {
                            if (data.memory && data.memory.labels.length > 0) {
                                memoryChart.data.labels = data.memory.labels;
                                memoryChart.data.datasets[0].data = data.memory.percents;
                                memoryChart.update();
                            }

                            if (data.cpu && data.cpu.labels.length > 0) {
                                cpuChart.data.labels = data.cpu.labels;
                                cpuChart.data.datasets[0].data = data.cpu.percents;
                                cpuChart.update();
                            }

                            if (data.requests && data.requests.datasets) {
                                requestsChart.data.labels = data.requests.labels;

                                for (var i = 0; i < data.requests.datasets.length; i++) {
                                    var newDataset = data.requests.datasets[i];
                                    var existingDataset = null;

                                    for (var j = 0; j < requestsChart.data.datasets.length; j++) {
                                        if (requestsChart.data.datasets[j].label === newDataset.label) {
                                            existingDataset = requestsChart.data.datasets[j];
                                            break;
                                        }
                                    }

                                    if (existingDataset) {
                                        existingDataset.data = newDataset.data;
                                    } else {
                                        var color = colorHash.hex(newDataset.label);
                                        requestsChart.data.datasets.push({
                                            label: newDataset.label,
                                            data: newDataset.data,
                                            borderColor: color,
                                            backgroundColor: color + '33',
                                            fill: true
                                        });
                                    }
                                }

                                var filteredDatasets = [];
                                for (var k = 0; k < requestsChart.data.datasets.length; k++) {
                                    var current = requestsChart.data.datasets[k];
                                    var found = false;
                                    for (var n = 0; n < data.requests.datasets.length; n++) {
                                        if (data.requests.datasets[n].label === current.label) {
                                            found = true;
                                            break;
                                        }
                                    }
                                    if (found) {
                                        filteredDatasets.push(current);
                                    }
                                }
                                requestsChart.data.datasets = filteredDatasets;

                                requestsChart.update();
                            }


                            if (data.ssh) {
                                var sshCurrent = document.getElementById('ssh-current');
                                sshCurrent.textContent = 'Current established: ' + (data.ssh.current || 0);

                                var sshTable = document.getElementById('ssh-table');
                                var sshSessions = data.ssh.sessions || [];
                                var sshRows = '';
                                for (var si = 0; si < sshSessions.length; si++) {
                                    var session = sshSessions[si];
                                    sshRows += '<div class="ssh-row">' +
                                        '<div class="ssh-ip">' + session.ip + ':' + session.port + '</div>' +
                                        '<div class="ssh-country">' + session.countryName + ' (' + session.countryCode + ')</div>' +
                                        '<div class="ssh-date">' + session.date + '</div>' +
                                        '<div class="ssh-time">' + session.time + '</div>' +
                                        '<div class="ssh-device">' + session.device + '</div>' +
                                    '</div>';
                                }
                                sshTable.innerHTML = sshRows || '<div class="disk-empty">No active SSH sessions.</div>';
                            }

                            if (data.countries) {
                                var countryTable = document.getElementById('country-table');
                                var countryRows = '';
                                for (var ci = 0; ci < data.countries.length; ci++) {
                                    var country = data.countries[ci];
                                    countryRows += '<div class="country-row">' +
                                        '<div class="country-name">' + country.name + ' <span>(' + country.code + ')</span></div>' +
                                        '<div class="country-count">' + country.count + '</div>' +
                                    '</div>';
                                }
                                countryTable.innerHTML = countryRows || '<div class="disk-empty">No country data yet.</div>';
                            }

                            if (data.disks) {
                                var table = document.getElementById('disk-table');
                                var rows = '';
                                for (var di = 0; di < data.disks.length; di++) {
                                    var disk = data.disks[di];
                                    rows += '<div class="disk-row">' +
                                        '<div class="disk-main">' +
                                            '<div class="disk-title">' + disk.mountpoint + '</div>' +
                                            '<div class="disk-subtitle">' + disk.device + ' • ' + disk.fstype + '</div>' +
                                        '</div>' +
                                        '<div class="disk-metrics">' +
                                            '<div><strong>' + disk.usedPercent.toFixed(1) + '%</strong> used</div>' +
                                            '<div>' + disk.freeGB.toFixed(1) + ' GB free / ' + disk.totalGB.toFixed(1) + ' GB total</div>' +
                                        '</div>' +
                                        '<div class="disk-bar">' +
                                            '<div class="disk-bar-fill" style="width: ' + disk.usedPercent.toFixed(1) + '%"></div>' +
                                        '</div>' +
                                    '</div>';
                                }
                                table.innerHTML = rows || '<div class="disk-empty">No disks found.</div>';
                            }

                            if (data.suspicious) {
                                var suspiciousTable = document.getElementById('suspicious-table');
                                var suspiciousRows = '';
                                for (var xi = 0; xi < data.suspicious.length; xi++) {
                                    var item = data.suspicious[xi];
                                    var action = item.banned
                                        ? '<button class="btn" data-unban-ip="' + item.ip + '">Unban</button>'
                                        : '<button class="btn btn-danger" data-ban-ip="' + item.ip + '">Ban</button>';
                                    if (!item.banned) {
                                        action += ' <button class="btn btn-icon" title="Remove from list" aria-label="Remove from list" data-remove-ip="' + item.ip + '">✕</button>';
                                    }
                                    suspiciousRows += '<div class="disk-row">' +
                                        '<div class="disk-main">' +
                                            '<div class="disk-title">' + item.ip + '</div>' +
                                            '<div class="disk-subtitle">' + item.reason + ' • hits: ' + item.count + '</div>' +
                                        '</div>' +
                                        '<div class="disk-metrics">' +
                                            '<div>first: ' + new Date(item.firstSeen).toLocaleString() + '</div>' +
                                            '<div>last: ' + new Date(item.lastSeen).toLocaleString() + '</div>' +
                                        '</div>' +
                                        '<div>' + action + '</div>' +
                                    '</div>';
                                }
                                suspiciousTable.innerHTML = suspiciousRows || '<div class="disk-empty">No suspicious IPs.</div>';

                                var banButtons = suspiciousTable.querySelectorAll('[data-ban-ip]');
                                for (var bi = 0; bi < banButtons.length; bi++) {
                                    banButtons[bi].addEventListener('click', function(ev) {
                                        var ip = ev.currentTarget.getAttribute('data-ban-ip');
                                        banIP(ip)
                                            .then(fetchData)
                                            .catch(function(error) { console.error(error); });
                                    });
                                }

                                var unbanButtons = suspiciousTable.querySelectorAll('[data-unban-ip]');
                                for (var ui = 0; ui < unbanButtons.length; ui++) {
                                    unbanButtons[ui].addEventListener('click', function(ev) {
                                        var ip = ev.currentTarget.getAttribute('data-unban-ip');
                                        unbanIP(ip)
                                            .then(fetchData)
                                            .catch(function(error) { console.error(error); });
                                    });
                                }

                                var removeButtons = suspiciousTable.querySelectorAll('[data-remove-ip]');
                                for (var ri = 0; ri < removeButtons.length; ri++) {
                                    removeButtons[ri].addEventListener('click', function(ev) {
                                        var ip = ev.currentTarget.getAttribute('data-remove-ip');
                                        removeIP(ip)
                                            .then(fetchData)
                                            .catch(function(error) { console.error(error); });
                                    });
                                }
                            }
                        })
                        .catch(function(error) {
                            console.error('Error fetching stats data:', error);
                        });
                }

                var manualBanBtn = document.getElementById('manual-ban-btn');
                var manualBanInput = document.getElementById('manual-ban-ip');
                if (manualBanBtn && manualBanInput) {
                    manualBanBtn.addEventListener('click', function() {
                        var ip = manualBanInput.value.trim();
                        if (!ip) {
                            return;
                        }
                        banIP(ip)
                            .then(function() {
                                manualBanInput.value = '';
                                return fetchData();
                            })
                            .catch(function(error) { console.error(error); });
                    });
                }

                setInterval(fetchData, 3000);
                fetchData();
            })();
        </script>
    </main>
</body>
</html>
