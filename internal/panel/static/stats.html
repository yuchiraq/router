<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stats - Router</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="/static/chart.js"></script>
    <script src="/static/color-hash.js"></script>
    <style>
        .btn-icon { padding: 4px 8px; min-width: auto; line-height: 1; background: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); font-size: 12px; }
        .stats-toolbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; }
        .stats-toolbar p { margin:0; color:var(--text-secondary); }
        .dashboard-canvas { position:relative; width:100%; min-height:1120px; border:1px dashed var(--border-color); border-radius:12px; }
        .dashboard-widget { position:absolute; margin:0; min-width:260px; min-height:220px; display:flex; flex-direction:column; }
        .dashboard-widget .card-header { cursor:grab; user-select:none; display:flex; align-items:center; gap:10px; }
        .dashboard-widget .card-body { flex:1; min-height:0; overflow:auto; }
        .dashboard-widget canvas { min-height:220px; }
        .widget-handle { color:var(--text-secondary); font-size:18px; line-height:1; }
        .dashboard-widget.dragging { opacity:0.88; z-index:50; box-shadow:0 10px 30px rgba(0,0,0,.35); }
        .widget-resizer { position:absolute; right:8px; bottom:8px; width:16px; height:16px; cursor:nwse-resize; background:linear-gradient(135deg, transparent 0 40%, var(--accent-blue) 40% 55%, transparent 55% 70%, var(--accent-blue) 70% 85%, transparent 85% 100%); }
        @media (max-width: 900px) {
            .stats-toolbar { flex-direction:column; align-items:flex-start; }
            .dashboard-canvas { min-height:1400px; }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="/account" class="nav-logo">Router</a>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/stats" class="active">Stats</a>
                <a href="/backups">Backups</a>
                <a href="/notifications">Notifications</a>
                <a href="/settings">GPT</a>
            </div>
        </div>
    </nav>
    <main class="container">
        <div class="header">
            <h1>Dashboard</h1>
        </div>

        <div class="stats-toolbar">
            <p>Перетаскивайте карточки по всей ширине и меняйте размер за угол (↘).</p>
            <button type="button" class="btn" id="reset-layout-btn">Reset layout</button>
        </div>

        <section class="dashboard-canvas" id="dashboard-canvas">
            <div class="card dashboard-widget" data-widget-id="memory" style="left:0px;top:0px;width:480px;height:320px;">
                <div class="card-header"><span class="widget-handle">⋮⋮</span><span>System Memory Usage</span></div>
                <div class="card-body"><canvas id="memory-chart"></canvas></div><div class="widget-resizer" title="Resize"></div>
            </div>
            <div class="card dashboard-widget" data-widget-id="cpu" style="left:500px;top:0px;width:480px;height:320px;">
                <div class="card-header"><span class="widget-handle">⋮⋮</span><span>System CPU Usage</span></div>
                <div class="card-body"><canvas id="cpu-chart"></canvas></div><div class="widget-resizer" title="Resize"></div>
            </div>
            <div class="card dashboard-widget" data-widget-id="requests" style="left:1000px;top:0px;width:560px;height:320px;">
                <div class="card-header"><span class="widget-handle">⋮⋮</span><span>Requests Per Hour</span></div>
                <div class="card-body"><canvas id="requests-chart"></canvas></div><div class="widget-resizer" title="Resize"></div>
            </div>
            <div class="card dashboard-widget" data-widget-id="ssh" style="left:0px;top:340px;width:760px;height:340px;">
                <div class="card-header"><span class="widget-handle">⋮⋮</span><span>SSH Connections</span></div>
                <div class="card-body"><div class="ssh-current" id="ssh-current">Current established: 0</div><div class="ssh-table ssh-table-head"><div>IP</div><div>Country</div><div>Date</div><div>Time</div><div>Device</div></div><div class="ssh-table" id="ssh-table"></div></div><div class="widget-resizer" title="Resize"></div>
            </div>
            <div class="card dashboard-widget" data-widget-id="countries" style="left:780px;top:340px;width:380px;height:340px;">
                <div class="card-header"><span class="widget-handle">⋮⋮</span><span>Requests by Country</span></div>
                <div class="card-body"><div class="country-table" id="country-table"></div></div><div class="widget-resizer" title="Resize"></div>
            </div>
            <div class="card dashboard-widget" data-widget-id="disks" style="left:1180px;top:340px;width:380px;height:340px;">
                <div class="card-header"><span class="widget-handle">⋮⋮</span><span>Disk Usage</span></div>
                <div class="card-body"><div class="disk-table" id="disk-table"></div></div><div class="widget-resizer" title="Resize"></div>
            </div>
            <div class="card dashboard-widget" data-widget-id="suspicious" style="left:0px;top:700px;width:780px;height:360px;">
                <div class="card-header"><span class="widget-handle">⋮⋮</span><span>Suspicious IPs</span></div>
                <div class="card-body"><div style="display:flex; gap:8px; margin-bottom:12px; align-items:center; flex-wrap:wrap;"><input type="text" id="manual-ban-ip" class="form-control" placeholder="Enter IP to ban (e.g. 203.0.113.10)" style="max-width:360px;"><button class="btn btn-danger" id="manual-ban-btn" type="button">Ban IP</button></div><div class="disk-table" id="suspicious-table"></div></div><div class="widget-resizer" title="Resize"></div>
            </div>
            <div class="card dashboard-widget" data-widget-id="autobanned" style="left:800px;top:700px;width:760px;height:360px;">
                <div class="card-header"><span class="widget-handle">⋮⋮</span><span>Auto-banned (24h)</span></div>
                <div class="card-body"><div class="disk-table" id="auto-banned-table"></div></div><div class="widget-resizer" title="Resize"></div>
            </div>
        </section>

        <script>
            (function () {
                var memoryCanvas = document.getElementById('memory-chart');
                var cpuCanvas = document.getElementById('cpu-chart');
                var requestsCanvas = document.getElementById('requests-chart');
                if (!memoryCanvas || !cpuCanvas || !requestsCanvas) {
                    console.warn('Charts not initialized: missing canvas elements.');
                    return;
                }

                var memoryContext = memoryCanvas.getContext('2d');
                var cpuContext = cpuCanvas.getContext('2d');
                var requestsContext = requestsCanvas.getContext('2d');

                if (!memoryContext || !cpuContext || !requestsContext) {
                    console.warn('Charts not initialized: missing canvas contexts.');
                    return;
                }

                // --- Chart Configuration ---
                var colorHash = new ColorHash({lightness: 0.6, saturation: 0.8});
                var styles = getComputedStyle(document.documentElement);
                var chartGrid = styles.getPropertyValue('--chart-grid').trim() || 'rgba(255, 255, 255, 0.1)';
                var chartTick = styles.getPropertyValue('--chart-tick').trim() || '#a0a0a5';

                var chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { color: chartGrid },
                            ticks: { color: chartTick }
                        },
                        y: {
                            grid: { color: chartGrid },
                            ticks: { color: chartTick },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: chartTick }
                        },
                        tooltip: {
                            callbacks: {}
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    tension: 0.4
                };

                // --- Memory Chart ---
                var memoryChartOptions = {
                    responsive: chartOptions.responsive,
                    maintainAspectRatio: chartOptions.maintainAspectRatio,
                    scales: {
                        x: {
                            grid: { color: chartGrid },
                            ticks: { color: chartTick }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: chartGrid },
                            ticks: { color: '#32D74B' },
                            beginAtZero: true,
                            suggestedMax: 100,
                            title: { display: true, text: '%', color: '#32D74B' }
                        }
                    },
                    plugins: {
                        legend: chartOptions.plugins.legend,
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + ' %';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    interaction: chartOptions.interaction,
                    tension: chartOptions.tension
                };

                var memoryChart = new Chart(memoryContext, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Used (%)',
                            data: [],
                            borderColor: '#32D74B',
                            backgroundColor: 'rgba(50, 215, 75, 0.2)',
                            fill: true,
                            yAxisID: 'y'
                        }]
                    },
                    options: memoryChartOptions
                });

                // --- CPU Chart ---
                var cpuChartOptions = {
                    responsive: chartOptions.responsive,
                    maintainAspectRatio: chartOptions.maintainAspectRatio,
                    scales: {
                        x: {
                            grid: { color: chartGrid },
                            ticks: { color: chartTick }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: chartGrid },
                            ticks: { color: '#FF9F0A' },
                            beginAtZero: true,
                            suggestedMax: 100,
                            title: { display: true, text: '%', color: '#FF9F0A' }
                        }
                    },
                    plugins: {
                        legend: chartOptions.plugins.legend,
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + ' %';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    interaction: chartOptions.interaction,
                    tension: chartOptions.tension
                };

                var cpuChart = new Chart(cpuContext, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Used (%)',
                            data: [],
                            borderColor: '#FF9F0A',
                            backgroundColor: 'rgba(255, 159, 10, 0.2)',
                            fill: true,
                            yAxisID: 'y'
                        }]
                    },
                    options: cpuChartOptions
                });

                // --- Requests Chart ---
                var requestsChart = new Chart(requestsContext, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: chartOptions
                });

                var canvas = document.getElementById('dashboard-canvas');
                var widgets = canvas ? Array.prototype.slice.call(canvas.querySelectorAll('.dashboard-widget')) : [];
                var layoutKey = 'router_stats_layout_v2';

                function clamp(value, min, max) {
                    return Math.max(min, Math.min(max, value));
                }

                function saveLayout() {
                    var payload = [];
                    for (var i = 0; i < widgets.length; i++) {
                        payload.push({
                            id: widgets[i].dataset.widgetId,
                            left: parseInt(widgets[i].style.left || '0', 10),
                            top: parseInt(widgets[i].style.top || '0', 10),
                            width: parseInt(widgets[i].style.width || '320', 10),
                            height: parseInt(widgets[i].style.height || '260', 10),
                            z: parseInt(widgets[i].style.zIndex || '1', 10)
                        });
                    }
                    localStorage.setItem(layoutKey, JSON.stringify(payload));
                }

                function refreshCanvasHeight() {
                    var maxBottom = 0;
                    for (var i = 0; i < widgets.length; i++) {
                        var top = parseInt(widgets[i].style.top || '0', 10);
                        var h = parseInt(widgets[i].style.height || '260', 10);
                        maxBottom = Math.max(maxBottom, top + h);
                    }
                    canvas.style.minHeight = String(maxBottom + 40) + 'px';
                }

                function restoreLayout() {
                    var savedRaw = localStorage.getItem(layoutKey);
                    if (!savedRaw) {
                        refreshCanvasHeight();
                        return;
                    }
                    try {
                        var saved = JSON.parse(savedRaw);
                        for (var i = 0; i < saved.length; i++) {
                            for (var j = 0; j < widgets.length; j++) {
                                if (widgets[j].dataset.widgetId === saved[i].id) {
                                    widgets[j].style.left = String(saved[i].left || 0) + 'px';
                                    widgets[j].style.top = String(saved[i].top || 0) + 'px';
                                    widgets[j].style.width = String(saved[i].width || 360) + 'px';
                                    widgets[j].style.height = String(saved[i].height || 260) + 'px';
                                    widgets[j].style.zIndex = String(saved[i].z || 1);
                                }
                            }
                        }
                    } catch (err) {
                        console.warn('layout restore failed', err);
                    }
                    refreshCanvasHeight();
                }

                function bringToFront(widget) {
                    var maxZ = 1;
                    for (var i = 0; i < widgets.length; i++) {
                        maxZ = Math.max(maxZ, parseInt(widgets[i].style.zIndex || '1', 10));
                    }
                    widget.style.zIndex = String(maxZ + 1);
                }

                function bindDrag(widget) {
                    var handle = widget.querySelector('.card-header');
                    if (!handle) return;
                    handle.addEventListener('mousedown', function(ev) {
                        if (ev.target && ev.target.classList && ev.target.classList.contains('widget-resizer')) return;
                        bringToFront(widget);
                        widget.classList.add('dragging');
                        var startX = ev.clientX;
                        var startY = ev.clientY;
                        var startLeft = parseInt(widget.style.left || '0', 10);
                        var startTop = parseInt(widget.style.top || '0', 10);

                        function onMove(moveEv) {
                            var nextLeft = startLeft + (moveEv.clientX - startX);
                            var nextTop = Math.max(0, startTop + (moveEv.clientY - startY));
                            widget.style.left = String(nextLeft) + 'px';
                            widget.style.top = String(nextTop) + 'px';
                            refreshCanvasHeight();
                        }

                        function onUp() {
                            widget.classList.remove('dragging');
                            window.removeEventListener('mousemove', onMove);
                            window.removeEventListener('mouseup', onUp);
                            saveLayout();
                        }

                        window.addEventListener('mousemove', onMove);
                        window.addEventListener('mouseup', onUp);
                    });
                }

                function bindResize(widget) {
                    var resizer = widget.querySelector('.widget-resizer');
                    if (!resizer) return;
                    resizer.addEventListener('mousedown', function(ev) {
                        ev.preventDefault();
                        ev.stopPropagation();
                        bringToFront(widget);
                        var startX = ev.clientX;
                        var startY = ev.clientY;
                        var startW = parseInt(widget.style.width || '360', 10);
                        var startH = parseInt(widget.style.height || '260', 10);

                        function onMove(moveEv) {
                            var nextW = clamp(startW + (moveEv.clientX - startX), 260, Math.max(320, canvas.clientWidth - 20));
                            var nextH = clamp(startH + (moveEv.clientY - startY), 220, 900);
                            widget.style.width = String(nextW) + 'px';
                            widget.style.height = String(nextH) + 'px';
                            memoryChart.resize();
                            cpuChart.resize();
                            requestsChart.resize();
                            refreshCanvasHeight();
                        }

                        function onUp() {
                            window.removeEventListener('mousemove', onMove);
                            window.removeEventListener('mouseup', onUp);
                            saveLayout();
                        }

                        window.addEventListener('mousemove', onMove);
                        window.addEventListener('mouseup', onUp);
                    });
                }

                for (var wi = 0; wi < widgets.length; wi++) {
                    bindDrag(widgets[wi]);
                    bindResize(widgets[wi]);
                }

                var resetLayoutBtn = document.getElementById('reset-layout-btn');
                if (resetLayoutBtn) {
                    resetLayoutBtn.addEventListener('click', function() {
                        localStorage.removeItem(layoutKey);
                        window.location.reload();
                    });
                }

                restoreLayout();

                // --- Data Fetching ---

                function banIP(ip) {
                    return fetch('/stats/ban', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: 'ip=' + encodeURIComponent(ip)
                    }).then(function(response) {
                        if (!response.ok) {
                            throw new Error('failed to ban ip ' + ip);
                        }
                    });
                }

                function unbanIP(ip) {
                    return fetch('/stats/unban', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: 'ip=' + encodeURIComponent(ip)
                    }).then(function(response) {
                        if (!response.ok) {
                            throw new Error('failed to unban ip ' + ip);
                        }
                    });
                }

                function removeIP(ip) {
                    return fetch('/stats/remove', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: 'ip=' + encodeURIComponent(ip)
                    }).then(function(response) {
                        if (!response.ok) {
                            throw new Error('failed to remove ip ' + ip);
                        }
                    });
                }

                function fetchData() {
                    fetch('/stats/data', { credentials: 'same-origin' })
                        .then(function(response) {
                            if (!response.ok) {
                                throw new Error('HTTP error! status: ' + response.status);
                            }
                            return response.json();
                        })
                        .then(function(data) {
                            if (data.memory && data.memory.labels.length > 0) {
                                memoryChart.data.labels = data.memory.labels;
                                memoryChart.data.datasets[0].data = data.memory.percents;
                                memoryChart.update();
                            }

                            if (data.cpu && data.cpu.labels.length > 0) {
                                cpuChart.data.labels = data.cpu.labels;
                                cpuChart.data.datasets[0].data = data.cpu.percents;
                                cpuChart.update();
                            }

                            if (data.requests && data.requests.datasets) {
                                requestsChart.data.labels = data.requests.labels;

                                for (var i = 0; i < data.requests.datasets.length; i++) {
                                    var newDataset = data.requests.datasets[i];
                                    var existingDataset = null;

                                    for (var j = 0; j < requestsChart.data.datasets.length; j++) {
                                        if (requestsChart.data.datasets[j].label === newDataset.label) {
                                            existingDataset = requestsChart.data.datasets[j];
                                            break;
                                        }
                                    }

                                    if (existingDataset) {
                                        existingDataset.data = newDataset.data;
                                    } else {
                                        var color = colorHash.hex(newDataset.label);
                                        requestsChart.data.datasets.push({
                                            label: newDataset.label,
                                            data: newDataset.data,
                                            borderColor: color,
                                            backgroundColor: color + '33',
                                            fill: true
                                        });
                                    }
                                }

                                var filteredDatasets = [];
                                for (var k = 0; k < requestsChart.data.datasets.length; k++) {
                                    var current = requestsChart.data.datasets[k];
                                    var found = false;
                                    for (var n = 0; n < data.requests.datasets.length; n++) {
                                        if (data.requests.datasets[n].label === current.label) {
                                            found = true;
                                            break;
                                        }
                                    }
                                    if (found) {
                                        filteredDatasets.push(current);
                                    }
                                }
                                requestsChart.data.datasets = filteredDatasets;

                                requestsChart.update();
                            }


                            if (data.ssh) {
                                var sshCurrent = document.getElementById('ssh-current');
                                sshCurrent.textContent = 'Current established: ' + (data.ssh.current || 0);

                                var sshTable = document.getElementById('ssh-table');
                                var sshSessions = data.ssh.sessions || [];
                                var sshRows = '';
                                for (var si = 0; si < sshSessions.length; si++) {
                                    var session = sshSessions[si];
                                    sshRows += '<div class="ssh-row">' +
                                        '<div class="ssh-ip">' + session.ip + ':' + session.port + '</div>' +
                                        '<div class="ssh-country">' + session.countryName + ' (' + session.countryCode + ')</div>' +
                                        '<div class="ssh-date">' + session.date + '</div>' +
                                        '<div class="ssh-time">' + session.time + '</div>' +
                                        '<div class="ssh-device">' + session.device + '</div>' +
                                    '</div>';
                                }
                                sshTable.innerHTML = sshRows || '<div class="disk-empty">No active SSH sessions.</div>';
                            }

                            if (data.countries) {
                                var countryTable = document.getElementById('country-table');
                                var countryRows = '';
                                for (var ci = 0; ci < data.countries.length; ci++) {
                                    var country = data.countries[ci];
                                    countryRows += '<div class="country-row">' +
                                        '<div class="country-name">' + country.name + ' <span>(' + country.code + ')</span></div>' +
                                        '<div class="country-count">' + country.count + '</div>' +
                                    '</div>';
                                }
                                countryTable.innerHTML = countryRows || '<div class="disk-empty">No country data yet.</div>';
                            }

                            if (data.disks) {
                                var table = document.getElementById('disk-table');
                                var rows = '';
                                for (var di = 0; di < data.disks.length; di++) {
                                    var disk = data.disks[di];
                                    rows += '<div class="disk-row">' +
                                        '<div class="disk-main">' +
                                            '<div class="disk-title">' + disk.mountpoint + '</div>' +
                                            '<div class="disk-subtitle">' + disk.device + ' • ' + disk.fstype + '</div>' +
                                        '</div>' +
                                        '<div class="disk-metrics">' +
                                            '<div><strong>' + disk.usedPercent.toFixed(1) + '%</strong> used</div>' +
                                            '<div>' + disk.freeGB.toFixed(1) + ' GB free / ' + disk.totalGB.toFixed(1) + ' GB total</div>' +
                                        '</div>' +
                                        '<div class="disk-bar">' +
                                            '<div class="disk-bar-fill" style="width: ' + disk.usedPercent.toFixed(1) + '%"></div>' +
                                        '</div>' +
                                    '</div>';
                                }
                                table.innerHTML = rows || '<div class="disk-empty">No disks found.</div>';
                            }

                            if (data.suspicious) {
                                var suspiciousTable = document.getElementById('suspicious-table');
                                var suspiciousRows = '';
                                for (var xi = 0; xi < data.suspicious.length; xi++) {
                                    var item = data.suspicious[xi];
                                    var action = item.banned
                                        ? '<button class="btn" data-unban-ip="' + item.ip + '">Unban</button>'
                                        : '<button class="btn btn-danger" data-ban-ip="' + item.ip + '">Ban</button>';
                                    if (!item.banned) {
                                        action += ' <button class="btn btn-icon" title="Remove from list" aria-label="Remove from list" data-remove-ip="' + item.ip + '">✕</button>';
                                    }
                                    suspiciousRows += '<div class="disk-row">' +
                                        '<div class="disk-main">' +
                                            '<div class="disk-title">' + item.ip + '</div>' +
                                            '<div class="disk-subtitle">' + item.reason + ' • hits: ' + item.count + (item.autoBanned ? ' • AUTO-BAN' : '') + '</div>' +
                                        '</div>' +
                                        '<div class="disk-metrics">' +
                                            '<div>first: ' + new Date(item.firstSeen).toLocaleString() + '</div>' +
                                            '<div>last: ' + new Date(item.lastSeen).toLocaleString() + '</div>' +
                                        '</div>' +
                                        '<div>' + action + '</div>' +
                                    '</div>';
                                }
                                suspiciousTable.innerHTML = suspiciousRows || '<div class="disk-empty">No suspicious IPs.</div>';

                                var banButtons = suspiciousTable.querySelectorAll('[data-ban-ip]');
                                for (var bi = 0; bi < banButtons.length; bi++) {
                                    banButtons[bi].addEventListener('click', function(ev) {
                                        var ip = ev.currentTarget.getAttribute('data-ban-ip');
                                        banIP(ip)
                                            .then(fetchData)
                                            .catch(function(error) { console.error(error); });
                                    });
                                }

                                var unbanButtons = suspiciousTable.querySelectorAll('[data-unban-ip]');
                                for (var ui = 0; ui < unbanButtons.length; ui++) {
                                    unbanButtons[ui].addEventListener('click', function(ev) {
                                        var ip = ev.currentTarget.getAttribute('data-unban-ip');
                                        unbanIP(ip)
                                            .then(fetchData)
                                            .catch(function(error) { console.error(error); });
                                    });
                                }

                                var removeButtons = suspiciousTable.querySelectorAll('[data-remove-ip]');
                                for (var ri = 0; ri < removeButtons.length; ri++) {
                                    removeButtons[ri].addEventListener('click', function(ev) {
                                        var ip = ev.currentTarget.getAttribute('data-remove-ip');
                                        removeIP(ip)
                                            .then(fetchData)
                                            .catch(function(error) { console.error(error); });
                                    });
                                }
                            }

                            if (data.autoBanned) {
                                var autoTable = document.getElementById('auto-banned-table');
                                var autoRows = '';
                                for (var ai = 0; ai < data.autoBanned.length; ai++) {
                                    var ban = data.autoBanned[ai];
                                    autoRows += '<div class="disk-row">' +
                                        '<div class="disk-main">' +
                                            '<div class="disk-title">' + ban.ip + '</div>' +
                                            '<div class="disk-subtitle">' + ban.reason + ' • hits: ' + ban.count + '</div>' +
                                        '</div>' +
                                        '<div class="disk-metrics">' +
                                            '<div>banned at: ' + new Date(ban.bannedAt).toLocaleString() + '</div>' +
                                            '<div>until: ' + new Date(ban.banUntil).toLocaleString() + '</div>' +
                                        '</div>' +
                                        '<div><button class="btn" data-unban-ip="' + ban.ip + '">Unban</button></div>' +
                                    '</div>';
                                }
                                autoTable.innerHTML = autoRows || '<div class="disk-empty">No auto-banned IPs now.</div>';

                                var autoUnbanButtons = autoTable.querySelectorAll('[data-unban-ip]');
                                for (var aui = 0; aui < autoUnbanButtons.length; aui++) {
                                    autoUnbanButtons[aui].addEventListener('click', function(ev) {
                                        var ip = ev.currentTarget.getAttribute('data-unban-ip');
                                        unbanIP(ip)
                                            .then(fetchData)
                                            .catch(function(error) { console.error(error); });
                                    });
                                }
                            }
                        })
                        .catch(function(error) {
                            console.error('Error fetching stats data:', error);
                        });
                }

                var manualBanBtn = document.getElementById('manual-ban-btn');
                var manualBanInput = document.getElementById('manual-ban-ip');
                if (manualBanBtn && manualBanInput) {
                    manualBanBtn.addEventListener('click', function() {
                        var ip = manualBanInput.value.trim();
                        if (!ip) {
                            return;
                        }
                        banIP(ip)
                            .then(function() {
                                manualBanInput.value = '';
                                return fetchData();
                            })
                            .catch(function(error) { console.error(error); });
                    });
                }

                setInterval(fetchData, 3000);
                fetchData();
            })();
        </script>
    </main>
</body>
</html>
