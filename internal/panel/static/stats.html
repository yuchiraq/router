
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stats - Router</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="/static/chart.js"></script>
    <script src="/static/color-hash.js"></script>
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="nav-logo">Router</a>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/stats" class="active">Stats</a>
            </div>
        </div>
    </nav>
    <main class="container">
        <div class="header">
            <h1>Dashboard</h1>
        </div>

        <div class="card">
            <div class="card-header">System Memory Usage</div>
            <div class="card-body">
                <canvas id="memory-chart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">System CPU Usage</div>
            <div class="card-body">
                <canvas id="cpu-chart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Requests Per Hour</div>
            <div class="card-body">
                <canvas id="requests-chart"></canvas>
            </div>
        </div>

        <script>
            // --- Chart Configuration ---
            const colorHash = new ColorHash({lightness: 0.6, saturation: 0.8});

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#a0a0a5' }
                    },
                    y: {
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#a0a0a5' },
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: '#f0f0f5' }
                    },
                    tooltip: {
                        callbacks: {}
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index',
                },
                tension: 0.4,
            };

            // --- Memory Chart --- //
            const memoryChartOptions = {
                ...chartOptions,
                plugins: {
                    ...chartOptions.plugins,
                    tooltip: {
                        ...chartOptions.plugins.tooltip,
                        callbacks: {
                            ...chartOptions.plugins.tooltip.callbacks,
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2) + ' %'; // Percentage
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#a0a0a5' }
                    },
                    y1: { // Percentage axis
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#32D74B' },
                        beginAtZero: true,
                        suggestedMax: 100,
                        title: {
                            display: true,
                            text: '%',
                            color: '#32D74B'
                        }
                    }
                }
            };

            const memoryChart = new Chart(document.getElementById('memory-chart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Used (%)',
                        data: [],
                        borderColor: '#32D74B',
                        backgroundColor: 'rgba(50, 215, 75, 0.2)',
                        fill: true,
                        yAxisID: 'y1',
                    }]
                },
                options: memoryChartOptions,
            });

            // --- CPU Chart --- //
            const cpuChartOptions = {
                ...chartOptions,
                plugins: {
                    ...chartOptions.plugins,
                    tooltip: {
                        ...chartOptions.plugins.tooltip,
                        callbacks: {
                            ...chartOptions.plugins.tooltip.callbacks,
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2) + ' %'; // Percentage
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#a0a0a5' }
                    },
                    y: { // Percentage axis
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#FF9F0A' },
                        beginAtZero: true,
                        suggestedMax: 100,
                        title: {
                            display: true,
                            text: '%',
                            color: '#FF9F0A'
                        }
                    }
                }
            };

            const cpuChart = new Chart(document.getElementById('cpu-chart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Used (%)',
                        data: [],
                        borderColor: '#FF9F0A',
                        backgroundColor: 'rgba(255, 159, 10, 0.2)',
                        fill: true,
                        yAxisID: 'y',
                    }]
                },
                options: cpuChartOptions,
            });

            // --- Requests Chart --- //
            const requestsChart = new Chart(document.getElementById('requests-chart').getContext('2d'), {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: chartOptions,
            });

            // --- Data Fetching ---
            function fetchData() {
                fetch('/stats/data')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Update Memory Chart
                        memoryChart.data.labels = data.memory.labels;
                        memoryChart.data.datasets[0].data = data.memory.percents;
                        memoryChart.update();

                        // Update CPU Chart
                        if (data.cpu) {
                            cpuChart.data.labels = data.cpu.labels;
                            cpuChart.data.datasets[0].data = data.cpu.percents;
                            cpuChart.update();
                        }

                        // Update Requests Chart
                        if (data.requests && data.requests.datasets) {
                            requestsChart.data.labels = data.requests.labels;
                            data.requests.datasets.forEach(newDataset => {
                                const existingDataset = requestsChart.data.datasets.find(d => d.label === newDataset.label);
                                if (existingDataset) {
                                    existingDataset.data = newDataset.data;
                                } else {
                                    const color = colorHash.hex(newDataset.label);
                                    requestsChart.data.datasets.push({
                                        ...newDataset,
                                        borderColor: color,
                                        backgroundColor: color + '33',
                                        fill: true,
                                    });
                                }
                            });
                            // Remove old datasets
                            requestsChart.data.datasets = requestsChart.data.datasets.filter(d => 
                                data.requests.datasets.some(nd => nd.label === d.label)
                            );

                            requestsChart.update();
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching stats data:', error);
                    });
            }

            // --- Initial Load & Interval ---
            setInterval(fetchData, 3000);
            fetchData();

        </script>
    </main>
</body>
</html>
